--source include/not_embedded.inc
--source include/not_windows.inc

# 1) Set valiables to be used in parameters of mysqld_safe.
let $MYSQLD_DATADIR= `SELECT @@datadir`;
let $MYSQL_BASEDIR= `SELECT @@basedir`;
let $MYSQL_SOCKET= `SELECT @@socket`;
let $MYSQL_TIMEZONE= `SELECT @@time_zone`;
let $MYSQL_PIDFILE= `SELECT @@pid_file`;
let $MYSQL_PORT= `SELECT @@port`;
let $MYSQL_MESSAGESDIR= `SELECT @@lc_messages_dir`;

# 2) Insert a check if mysqld_safe is existing.
--file_exists $MYSQLD_SAFE

# 3) Shutdown mysqld which is started by mtr.
--let $_server_id= `SELECT @@server_id`
--let $_expect_file_name= $MYSQLTEST_VARDIR/tmp/mysqld.$_server_id.expect
--exec echo "wait" > $_expect_file_name
--shutdown_server 10
--source include/wait_until_disconnected.inc

# 4) Run the mysqld_safe script with exec.
--exec sh $MYSQLD_SAFE --defaults-file=$MYSQLTEST_VARDIR/my.cnf --log-error=$MYSQLTEST_VARDIR/log/err.log --basedir=$MYSQL_BASEDIR --ledir=$MYSQL_BASEDIR/sql --datadir=$MYSQLD_DATADIR --socket=$MYSQL_SOCKET --pid-file=$MYSQL_PIDFILE --port=$MYSQL_PORT --timezone=SYSTEM --log-output=file --loose-debug-sync-timeout=600 --default-storage-engine=InnoDB --default-tmp-storage-engine=InnoDB --loose-skip-log-bin --core-file --lc-messages-dir=$MYSQL_MESSAGESDIR < /dev/null > /dev/null 2>&1 &

# Delay introduced - mysqld_safe takes some time to start mysqld
--sleep 5

# 5) Reconnect to mysqld again
connection default;

# 6) Execute some SQL 
--exec $MYSQL -h localhost -S $MYSQL_SOCKET -P $MYSQL_PORT -u root -e "SHOW DATABASES; USE test; CREATE TABLE t1(a INT); SHOW CREATE TABLE t1" 2>&1

# 7) Kill mysqld, which must be restarted now automaticly by mysqld_safe 

--exec sh $MYSQL_BASEDIR/mysql-test/t/mysqld_safe.sh $MYSQL_PIDFILE 2>&1

# Delay introduced - mysqld_safe takes some time to restart mysqld

--sleep 5

# 8) Execute some SQL

--exec $MYSQL -h localhost -S $MYSQL_SOCKET -P $MYSQL_PORT -u root -e "SHOW DATABASES; USE test; SELECT * FROM t1" 2>&1

# 9) Shutdown mysqld with mysqladmin
--exec $MYSQLADMIN --host=127.0.0.1 -P $MYSQL_PORT -u root shutdown 2>&1

# 10) Restart mysqld of mtr
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc

# 11) cleanup
drop table t1;


