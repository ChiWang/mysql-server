# WL#6745 InnoDB R-tree support
# This test case test R-tree crash/recovery.

# Not supported in embedded
--source include/not_embedded.inc

--source include/have_innodb.inc
--source include/have_debug.inc
--source include/not_valgrind.inc

# Create table with R-tree index.
create table t1 (c1 int, c2 geometry not null, spatial index (c2))engine=innodb;

# Insert enough values to let R-tree split.
delimiter |;
create procedure insert_t1(IN total int)
begin
	declare i int default 1;
	while (i <= total) DO
		insert into t1 values (i, Point(i, i));
		set i = i + 1;
	end while;
end|
delimiter ;|

# Test crash recovery.
#
# Write file to make mysql-test-run.pl expect the "crash", but don't start
# it until it's told to
call mtr.add_suppression("InnoDB: A page in the doublewrite buffer is not within space bounds.*");

--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

# Test level 1 rtree.
CALL insert_t1(367);

# Request a crash, and restart the server.
SET DEBUG='+d,crash_commit_after';
# Write file to make mysql-test-run.pl restart the server
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
COMMIT;

#
# Turn on reconnect
--enable_reconnect
#
# Call script that will poll the server waiting for it to be back online again
--source include/wait_until_connected_again.inc
#
# Turn off reconnect again
--disable_reconnect
--echo

# Check table.
check table t1;

# Clean up.
drop procedure insert_t1;
drop table t1;
