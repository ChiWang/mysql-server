# Init for ndb_show_tables result
CREATE TEMPORARY TABLE IF NOT EXISTS ndb_show_tables_results (
id INT,
type VARCHAR(20),
state VARCHAR(20),
logging VARCHAR(20),
_database VARCHAR(255),
_schema VARCHAR(20),
name VARCHAR(255)
);
#
# Create child tables before parents
# by turning off foreign_key_checks for this session
#
set @save_foreign_key_checks = @@foreign_key_checks;
select @@foreign_key_checks;
@@foreign_key_checks
1
set @@foreign_key_checks=0;
create table t1 (
pk int not null primary key,
b int,
foreign key (b) references t2(pk1)
) engine=ndb;
create table t3 (
pk int not null primary key,
b int, c int,
d int, e int, f int,
g int, h int, i int, j int,
foreign key (b, c) references t4(pk1, pk2),
foreign key (d, e, f) references t5(uk1, uk2, uk3),
foreign key (g, h, i, j) references t6(oi1, oi2, oi3, oi4)
) engine=ndb;

ndb_show_tables completed.....

# There should be 4 dummy tables created
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
4
# There should be 1 dummy table created for t1
select type, name from ndb_show_tables_results
where name like "'NDB$DUMMY_<id>%'";
type	name
'UserTable'	'NDB$DUMMY_<id>_0_t2'
# There should be 3 dummy tables created for t3
select type, name from ndb_show_tables_results
where name like "'NDB$DUMMY_<id>%'" order by name;
type	name
'UserTable'	'NDB$DUMMY_<id>_0_t4'
'UserTable'	'NDB$DUMMY_<id>_1_t5'
'UserTable'	'NDB$DUMMY_<id>_2_t6'
drop table t3;

ndb_show_tables completed.....

# There should be 1 dummy table
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
1
# Only t1 should have 1 dummy table
select type, name from ndb_show_tables_results
where name like "'NDB$DUMMY_<id>%'";
type	name
'UserTable'	'NDB$DUMMY_<id>_0_t2'
drop table t1;
# There should be 0 dummy tables
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
1
#
# Create child table before parent
# by turning off foreign_key_checks for this session
#
create table t1 (
pk int not null primary key,
b int,
foreign key (b) references t2(pk1)
) engine=ndb;
create table t2 (
pk1 int not null primary key,
c int
) engine=ndb;

ndb_show_tables completed.....

# There should be 0 dummy tables
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
0
# Verify that fk is working now when parent has been resolved
set foreign_key_checks=1;
insert into t1 values(1, 2);
ERROR 23000: Cannot add or update a child row: a foreign key constraint fails (Unknown error code)
set foreign_key_checks=0;
drop table t1, t2;
#
# Exceed table name when creating the dummy table by referencing
# a not yet created table with really long name
#
# 1) By blowing the dummy_tabname buffer(currently 512 bytes)
create table t1 (
pk int not null primary key,
b int,
foreign key (b) references abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_abcdefghijklmnopqrstuvxyz_(pk1)
) engine=ndb;
ERROR HY000: Cannot add foreign key constraint
show warnings;
Level	Code	Message
Warning	1215	Failed to create dummy parent table, too long dummy name
Error	1215	Cannot add foreign key constraint
#
# show create of table with dummy table references
#
create table t1 (
a int not null,
b int not null,
c int not null,
primary key (a),
unique key (b) using hash,
key (c),
constraint fk1 foreign key(a) references t2 (a),
constraint fk2 foreign key(b) references t3 (a),
constraint fk3 foreign key(c) references t4 (a),
constraint fk4 foreign key(a) references t2 (b),
constraint fk5 foreign key(b) references t3 (b),
constraint fk6 foreign key(c) references t4 (b)
) engine=ndbcluster;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) NOT NULL,
  `b` int(11) NOT NULL,
  `c` int(11) NOT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `b` (`b`) USING HASH,
  KEY `c` (`c`),
 CONSTRAINT `fk1` FOREIGN KEY(`a`) REFERENCES `t2` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk2` FOREIGN KEY(`b`) REFERENCES `t3` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk3` FOREIGN KEY(`c`) REFERENCES `t4` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk4` FOREIGN KEY(`a`) REFERENCES `t2` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk5` FOREIGN KEY(`b`) REFERENCES `t3` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk6` FOREIGN KEY(`c`) REFERENCES `t4` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=ndbcluster DEFAULT CHARSET=latin1
create table t2 (
a int primary key,
b int not null,
c int not null,
unique(b) using hash,
index(c)
) engine = ndb;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) NOT NULL,
  `b` int(11) NOT NULL,
  `c` int(11) NOT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `b` (`b`) USING HASH,
  KEY `c` (`c`),
 CONSTRAINT `fk2` FOREIGN KEY(`b`) REFERENCES `t3` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk3` FOREIGN KEY(`c`) REFERENCES `t4` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk5` FOREIGN KEY(`b`) REFERENCES `t3` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk6` FOREIGN KEY(`c`) REFERENCES `t4` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk1` FOREIGN KEY(`a`) REFERENCES `t2` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk4` FOREIGN KEY(`a`) REFERENCES `t2` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=ndbcluster DEFAULT CHARSET=latin1
set @@ndb_show_foreign_key_dummies= 1;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) NOT NULL,
  `b` int(11) NOT NULL,
  `c` int(11) NOT NULL,
  PRIMARY KEY (`a`),
  UNIQUE KEY `b` (`b`) USING HASH,
  KEY `c` (`c`),
 CONSTRAINT `fk2` FOREIGN KEY(`b`) REFERENCES `NDB$DUMMY_10_1_t3` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk3` FOREIGN KEY(`c`) REFERENCES `NDB$DUMMY_10_2_t4` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk5` FOREIGN KEY(`b`) REFERENCES `NDB$DUMMY_10_4_t3` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk6` FOREIGN KEY(`c`) REFERENCES `NDB$DUMMY_10_5_t4` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk1` FOREIGN KEY(`a`) REFERENCES `t2` (`a`) ON DELETE NO ACTION ON UPDATE NO ACTION,
 CONSTRAINT `fk4` FOREIGN KEY(`a`) REFERENCES `t2` (`b`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=ndbcluster DEFAULT CHARSET=latin1
set @@ndb_show_foreign_key_dummies= 0;
drop table t1, t2;
#
# Create child table and then the parent
# which does not match the fk
#
create table t1 (
pk int not null primary key,
b int,
foreign key (b) references t2(pk1)
) engine=ndb;
create table t2 (
pk2 int not null primary key,
c int
) engine=ndb;
Warnings:
Warning	1215	Could not resolve 't2' as fk parent for 'test/def/t1' since it didn't have all the referenced columns

ndb_show_tables completed.....

# There should be 1 dummy table still
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
1
drop table t1, t2;
#
# Create child table and then the parent
# which does not match any index
#
create table t1 (
pk int not null primary key,
b int,
foreign key (b) references t2(c)
) engine=ndb;
create table t2 (
pk1 int not null primary key,
c int
) engine=ndb;
Warnings:
Warning	1215	Could not resolve 't2' as fk parent for 'test/def/t1' since no matching index could be found

ndb_show_tables completed.....

# There should be 1 dummy table still
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
1
drop table t1, t2;
set @@ndb_show_foreign_key_dummies= 1;
#
# Test where FK goes from t1->t2->t3->t4 and tables are created in that order
create table t1 (
pk11 int not null primary key,
b int,
foreign key (b) references t2(pk21)
) engine=ndb;
Warnings:
Warning	1003	Created dummy table 'NDB$DUMMY_10_0_t2' referenced by 't1'
create table t2 (
pk21 int not null primary key,
b int, c int,
foreign key (b, c) references t3(pk31, pk32)
) engine=ndb;
Warnings:
Warning	1003	Created dummy table 'NDB$DUMMY_15_0_t3' referenced by 't2'
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_0_t2' - resolved by 't2'
create table t3 (
pk31 int not null,
pk32 int not null,
primary key(pk31, pk32),
d int, e int,f int,
foreign key (d,e,f) references t4(pk41, pk42, pk43)
) engine=ndb;
Warnings:
Warning	1003	Created dummy table 'NDB$DUMMY_13_0_t4' referenced by 't3'
Warning	1003	Dropped dummy table 'NDB$DUMMY_15_0_t3' - resolved by 't3'
create table t4 (
pk41 int not null,
pk42 int not null,
pk43 int not null,
primary key(pk41, pk42, pk43),
m varchar(55)
) engine=ndb;
Warnings:
Warning	1003	Dropped dummy table 'NDB$DUMMY_13_0_t4' - resolved by 't4'

ndb_show_tables completed.....

# There should be no dummy tables
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
0
drop table t1, t2, t3, t4;
#
# Test where FK 'fans out' t1->t2 t1->t3 t1->t4, create t1 first
create table t1 (
pk11 int not null primary key,
b int,
foreign key (b) references t2(c),
d int, e int,
foreign key (d, e) references t3(f, g),
h varchar(55), i int, j datetime,
foreign key (h, i, j) references t4(k, l, m)
) engine=ndb;
Warnings:
Warning	1003	Created dummy table 'NDB$DUMMY_10_0_t2' referenced by 't1'
Warning	1003	Created dummy table 'NDB$DUMMY_10_1_t3' referenced by 't1'
Warning	1003	Created dummy table 'NDB$DUMMY_10_2_t4' referenced by 't1'
create table t2 (
pk21 int not null primary key,
c int,
unique(c)
) engine=ndb;
Warnings:
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_0_t2' - resolved by 't2'
create table t3 (
pk31 int not null,
pk32 int not null,
primary key(pk31, pk32),
g int, f int,
unique(f, g)
) engine=ndb;
Warnings:
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_1_t3' - resolved by 't3'
create table t4 (
pk41 int not null,
pk42 int not null,
pk43 int not null,
primary key(pk41, pk42, pk43),
m varchar(55), l int, k datetime,
unique(k, l, m)
) engine=ndb;
Warnings:
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_2_t4' - resolved by 't4'

ndb_show_tables completed.....

# There should be no dummy tables
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
0
drop table t1, t2, t3, t4;
#
# Test where FK refers to 2+ different indices in parent t1->t2(1) t1->t2(2)
create table t1 (
pk11 int not null primary key,
foreign key (pk11) references t2(pk21),
b int,
foreign key (b) references t2(c),
d int, e int,
foreign key (d, e) references t2(f, g),
h varchar(55), i int, j datetime,
foreign key (h, i, j) references t2(k, l, m)
) engine=ndb;
Warnings:
Warning	1003	Created dummy table 'NDB$DUMMY_10_0_t2' referenced by 't1'
Warning	1003	Created dummy table 'NDB$DUMMY_10_1_t2' referenced by 't1'
Warning	1003	Created dummy table 'NDB$DUMMY_10_2_t2' referenced by 't1'
Warning	1003	Created dummy table 'NDB$DUMMY_10_3_t2' referenced by 't1'
create table t2 (
pk21 int not null primary key,
c int,
unique(c),
g int, f int,
unique(f, g),
m varchar(55), l int, k datetime,
unique(k, l, m)
) engine=ndb;
Warnings:
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_0_t2' - resolved by 't2'
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_1_t2' - resolved by 't2'
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_2_t2' - resolved by 't2'
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_3_t2' - resolved by 't2'

ndb_show_tables completed.....

# There should be no dummy tables
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
0
drop table t1, t2;
#
# Test drop of referenced table(dummy table should be created)
#
create table t1 (
pk1 int not null primary key,
foreign key (pk1) references t2(pk2),
a varchar(255)
) engine=ndb;
Warnings:
Warning	1003	Created dummy table 'NDB$DUMMY_10_0_t2' referenced by 't1'
create table t2 (
pk2 int not null primary key,
b datetime
) engine=ndb;
Warnings:
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_0_t2' - resolved by 't2'

ndb_show_tables completed.....

# There should be no dummy tables
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
0
drop table t2;
Warnings:
Warning	1003	Created dummy table 'NDB$DUMMY_10_0_t2' referenced by 't1'

ndb_show_tables completed.....

# There should be 1 dummy table created for t1
select type, name from ndb_show_tables_results
where name like "'NDB$DUMMY_<id>%'";
type	name
'UserTable'	'NDB$DUMMY_<id>_0_t2'
drop table t1;
Warnings:
Warning	1003	Dropped dummy table 'NDB$DUMMY_10_0_t2' - referencing table dropped

ndb_show_tables completed.....

# There should be no dummy tables
select count(*) from ndb_show_tables_results where name like "'NDB\$DUMMY%'";
count(*)
0
