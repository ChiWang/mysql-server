-- source include/have_ndb.inc

create table parent (
  a int primary key auto_increment,
  b int not null,
  c int not null,
  unique(b) using hash,
  index(c)) engine = ndb;

create table child (
  a int primary key auto_increment,
  b int not null,
  c int not null,
  unique(b) using hash,
  index(c)) engine = ndb;

create table grandchild (
  a int primary key auto_increment,
  b int not null,
  c int not null,
  unique(b) using hash,
  index(c)) engine = ndb;

#
# Test deferred DELETE cascade
#

alter table child add constraint fkname foreign key (a) references parent (a)
on delete cascade on update restrict;

alter table grandchild add constraint fkname foreign key (a) references child
(a) on delete cascade on update restrict;

insert into parent values (1,1,1),(2,2,2);
insert into child values (1,1,1),(2,2,2);
insert into grandchild values (1,1,1),(2,2,2);

set ndb_deferred_constraints = 0;

begin;
delete from parent where a = 1;
select * from child order by 1,2,3;
select * from grandchild order by 1,2,3;
rollback;

set ndb_deferred_constraints = 1;

begin;
delete from parent where a = 1;
select * from child order by 1,2,3;
select * from grandchild order by 1,2,3;
commit;

# the deletes should show now...
select * from child order by 1,2,3;
select * from grandchild order by 1,2,3;

drop table grandchild, child, parent;
