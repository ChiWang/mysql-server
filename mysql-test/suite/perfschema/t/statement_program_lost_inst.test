#-------------------------------------------------------------
# Tests for PERFORMANCE_SCHEMA stored programs instrumentation  
#-------------------------------------------------------------

#
#  Test case to show the behaviour of stored program instrumentation 
#  when values of the system variables performance_schema_max_program_instances & 
#  performance_schema_max_statement_stack are less than the statistics collected. 
#  The status of the lost instrumentation is shown through the status variables
#  performance_schema_program_lost & performance_schema_nested_statement_lost
#  

--source include/not_embedded.inc
--source include/have_perfschema.inc

--source ../include/start_server_common.inc

# Values of variables server variables
show variables like "performance_schema_max_program_instances";
show variables like "performance_schema_max_statement_stack";

--echo ##################### 
--echo # Setup
--echo ##################### 
--source suite/perfschema/include/program_nested_setup.inc 

# Truncate summary table
TRUNCATE performance_schema.events_statements_summary_by_program;
SELECT OBJECT_TYPE, OBJECT_NAME, OBJECT_SCHEMA FROM 
performance_schema.events_statements_summary_by_program 
WHERE OBJECT_SCHEMA='nested_sp';

# Flush status now
Flush status;
show status like "%performance_schema_program_lost%";
show status like "%performance_schema_nested_statement_lost%";

--echo ##################### 
--echo # Executing Queries
--echo ##################### 
--source suite/perfschema/include/program_nested_execution.inc 

--echo ###########################################
--echo # Quering PS statement summary table      #
--echo ########################################### 

SELECT OBJECT_TYPE, OBJECT_NAME, OBJECT_SCHEMA
       FROM performance_schema.events_statements_summary_by_program
       WHERE OBJECT_SCHEMA='nested_sp' ORDER BY OBJECT_NAME;

# Now check the lost status
show status like "%performance_schema_program_lost%";
show status like "%performance_schema_nested_statement_lost%";

--echo ##################### 
--echo # Cleanup
--echo ##################### 
--source suite/perfschema/include/program_nested_cleanup.inc 
