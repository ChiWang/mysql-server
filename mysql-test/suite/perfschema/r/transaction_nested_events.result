
#========================================================================
# STEP 1 - SETUP
#========================================================================

## Setup control thread

SET SESSION AUTOCOMMIT= 1;
USE test;
DROP DATABASE IF EXISTS db;

## Create test database, test tables, one transactional and one non-transactional
CREATE DATABASE db;
CREATE TABLE db.t1 (s1 int, s2 varchar(64)) ENGINE=INNODB;
CREATE TABLE db.nt1 (s1 int, s2 varchar(64)) ENGINE=MYISAM;

## Setup connection 1
USE db;
SET SESSION AUTOCOMMIT = 1;
SELECT thread_id INTO @my_thread_id
FROM performance_schema.threads
WHERE processlist_id = connection_id();

## Disable events from the control (default) connection
UPDATE performance_schema.threads SET instrumented = 'NO' WHERE processlist_id = CONNECTION_ID();
SET @all_threads= 0;

## Enable only transaction and statement instruments
UPDATE performance_schema.setup_instruments SET enabled='NO', timed='NO';
UPDATE performance_schema.setup_instruments SET enabled='YES'
  WHERE name LIKE ('statement/%') OR name = 'transaction';

## Clear statement and transaction history
CALL test.clear_history();

#========================================================================
# STEP 2 - BASIC TRANSACTION
#========================================================================
#
# STEP 2.1 - IMPLICIT
#
INSERT INTO t1 VALUES (210, "INSERT 210");
INSERT INTO t1 VALUES (211, "INSERT 211");
INSERT INTO t1 VALUES (212, "INSERT 212");
UPDATE t1 SET s1 = s1 + 1 WHERE s1 = 212;
#========================================================================
# Verify
#========================================================================
EVENTS_TRANSACTIONS_CURRENT

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

EVENTS_TRANSACTIONS_HISTORY_LONG

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

## Combined statement and transaction event history ordered by event id

EVENTS_STATEMENTS_HISTORY_LONG + EVENTS_TRANSACTIONS_HISTORY_LONG

EVENT_ID	EVENT_NAME               	NESTING_EVENT_ID	NESTING_EVENT_TYPE	SQL_TXT
event_id	statement/sql/insert     	nesting_event_id	NULL              	INSERT INTO t1 VALUES (210, "INSERT 210")
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/insert     	nesting_event_id	NULL              	INSERT INTO t1 VALUES (211, "INSERT 211")
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/insert     	nesting_event_id	NULL              	INSERT INTO t1 VALUES (212, "INSERT 212")
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/update     	nesting_event_id	NULL              	UPDATE t1 SET s1 = s1 + 1 WHERE s1 = 212
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>

## Clear statement and transaction history
CALL test.clear_history();
## Reset db.t1
DELETE FROM db.t1;

#
# STEP 2.2 - EXPLICIT
#
START TRANSACTION;
INSERT INTO t1 VALUES (220, "INSERT 220"), (221, "INSERT 221");
UPDATE t1 SET s2 = "UPDATE 221" WHERE s1 = 221;
COMMIT;
#========================================================================
# Verify
#========================================================================
EVENTS_TRANSACTIONS_CURRENT

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         

EVENTS_TRANSACTIONS_HISTORY_LONG

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         

## Combined statement and transaction event history ordered by event id

EVENTS_STATEMENTS_HISTORY_LONG + EVENTS_TRANSACTIONS_HISTORY_LONG

EVENT_ID	EVENT_NAME               	NESTING_EVENT_ID	NESTING_EVENT_TYPE	SQL_TXT
event_id	statement/sql/begin      	nesting_event_id	NULL              	START TRANSACTION
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (220, "INSERT 220"), (221, "INSERT 221")
event_id	statement/sql/update     	nesting_event_id	TRANSACTION       	UPDATE t1 SET s2 = "UPDATE 221" WHERE s1 = 221
event_id	statement/sql/commit     	nesting_event_id	TRANSACTION       	COMMIT

## Clear statement and transaction history
CALL test.clear_history();
## Reset db.t1
DELETE FROM db.t1;

#========================================================================
# STEP 3 - TRANSACTIONS AND STORED PROCEDURES
#========================================================================
#
# STEP 3.1 - STORED PROCEDURE STARTED WITHIN TRANSACTION
#
CREATE PROCEDURE tp_update() UPDATE t1 SET s1 = s1 + 1;

START TRANSACTION;
INSERT INTO t1 VALUES (310, "INSERT 310");
INSERT INTO t1 VALUES (311, "INSERT 311");
INSERT INTO t1 VALUES (312, "INSERT 312");
INSERT INTO t1 VALUES (313, "INSERT 313");
CALL tp_update();
COMMIT;
#========================================================================
# Verify
#========================================================================
EVENTS_TRANSACTIONS_CURRENT

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         

EVENTS_TRANSACTIONS_HISTORY_LONG

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         

## Combined statement and transaction event history ordered by event id

EVENTS_STATEMENTS_HISTORY_LONG + EVENTS_TRANSACTIONS_HISTORY_LONG

EVENT_ID	EVENT_NAME               	NESTING_EVENT_ID	NESTING_EVENT_TYPE	SQL_TXT
event_id	statement/sql/create_proc	nesting_event_id	NULL              	CREATE PROCEDURE tp_update() UPDATE t1 SET s1 = s1 + 1
event_id	statement/sql/begin      	nesting_event_id	NULL              	START TRANSACTION
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (310, "INSERT 310")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (311, "INSERT 311")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (312, "INSERT 312")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (313, "INSERT 313")
event_id	statement/sql/call_proced	nesting_event_id	TRANSACTION       	CALL tp_update()
event_id	statement/sp/stmt        	nesting_event_id	STATEMENT         	UPDATE t1 SET s1 = s1 + 1
event_id	statement/sql/commit     	nesting_event_id	TRANSACTION       	COMMIT

## Clear statement and transaction history
CALL test.clear_history();
## Reset db.t1
DELETE FROM db.t1;

#
# STEP 3.2 - TRANSACTION STARTED WITHIN STORED PROCEDURE
#
CREATE PROCEDURE tp_start() START TRANSACTION;

CALL tp_start();
INSERT INTO t1 VALUES (320, "INSERT 320"),(321, "INSERT 321");
INSERT INTO t1 VALUES (322, "INSERT 322"),(323, "INSERT 323");
UPDATE t1 SET s1 = s1 + 1 WHERE s1 > 320;

SELECT * FROM t1 ORDER BY s1;
s1	s2
320	INSERT 320
322	INSERT 321
323	INSERT 322
324	INSERT 323
COMMIT;
#========================================================================
# Verify
#========================================================================
EVENTS_TRANSACTIONS_CURRENT

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         

EVENTS_TRANSACTIONS_HISTORY_LONG

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         

## Combined statement and transaction event history ordered by event id

EVENTS_STATEMENTS_HISTORY_LONG + EVENTS_TRANSACTIONS_HISTORY_LONG

EVENT_ID	EVENT_NAME               	NESTING_EVENT_ID	NESTING_EVENT_TYPE	SQL_TXT
event_id	statement/sql/create_proc	nesting_event_id	NULL              	CREATE PROCEDURE tp_start() START TRANSACTION
event_id	statement/sql/call_proced	nesting_event_id	NULL              	CALL tp_start()
event_id	statement/sp/stmt        	nesting_event_id	STATEMENT         	START TRANSACTION
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (320, "INSERT 320"),(321, "INSERT 321")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (322, "INSERT 322"),(323, "INSERT 323")
event_id	statement/sql/update     	nesting_event_id	TRANSACTION       	UPDATE t1 SET s1 = s1 + 1 WHERE s1 > 320
event_id	statement/sql/select     	nesting_event_id	TRANSACTION       	SELECT * FROM t1 ORDER BY s1
event_id	statement/sql/commit     	nesting_event_id	TRANSACTION       	COMMIT

## Clear statement and transaction history
CALL test.clear_history();
## Reset db.t1
DELETE FROM db.t1;

#
# STEP 3.3 - TRANSACTION ENDED WITHIN STORED PROCEDURE
#
CREATE PROCEDURE tp_rollback() ROLLBACK;
CREATE PROCEDURE tp_commit() COMMIT;

## COMMIT within stored procedure
START TRANSACTION;
INSERT INTO t1 VALUES (330, "INSERT 330"),(331, "INSERT 331");
INSERT INTO t1 VALUES (332, "INSERT 332"),(333, "INSERT 333");
DELETE FROM t1 WHERE s1 > 331;
CALL tp_commit();

SELECT * FROM t1 ORDER BY s1;
s1	s2
330	INSERT 330
331	INSERT 331

## ROLLBACK within stored procedure
START TRANSACTION;
UPDATE t1 SET s1 = s1*2 WHERE s1 > 331;
CALL tp_rollback();

SELECT * FROM t1 ORDER BY s1;
s1	s2
330	INSERT 330
331	INSERT 331
#========================================================================
# Verify
#========================================================================
EVENTS_TRANSACTIONS_CURRENT

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

EVENTS_TRANSACTIONS_HISTORY_LONG

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	ROLLED BACK	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

## Combined statement and transaction event history ordered by event id

EVENTS_STATEMENTS_HISTORY_LONG + EVENTS_TRANSACTIONS_HISTORY_LONG

EVENT_ID	EVENT_NAME               	NESTING_EVENT_ID	NESTING_EVENT_TYPE	SQL_TXT
event_id	statement/sql/create_proc	nesting_event_id	NULL              	CREATE PROCEDURE tp_rollback() ROLLBACK
event_id	statement/sql/create_proc	nesting_event_id	NULL              	CREATE PROCEDURE tp_commit() COMMIT
event_id	statement/sql/begin      	nesting_event_id	NULL              	START TRANSACTION
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (330, "INSERT 330"),(331, "INSERT 331")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (332, "INSERT 332"),(333, "INSERT 333")
event_id	statement/sql/delete     	nesting_event_id	TRANSACTION       	DELETE FROM t1 WHERE s1 > 331
event_id	statement/sql/call_proced	nesting_event_id	TRANSACTION       	CALL tp_commit()
event_id	statement/sp/stmt        	nesting_event_id	STATEMENT         	COMMIT
event_id	statement/sql/select     	nesting_event_id	NULL              	SELECT * FROM t1 ORDER BY s1
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/begin      	nesting_event_id	NULL              	START TRANSACTION
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/update     	nesting_event_id	TRANSACTION       	UPDATE t1 SET s1 = s1*2 WHERE s1 > 331
event_id	statement/sql/call_proced	nesting_event_id	TRANSACTION       	CALL tp_rollback()
event_id	statement/sp/stmt        	nesting_event_id	STATEMENT         	ROLLBACK
event_id	statement/sql/select     	nesting_event_id	NULL              	SELECT * FROM t1 ORDER BY s1
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>

## Clear statement and transaction history
CALL test.clear_history();
## Reset db.t1
DELETE FROM db.t1;

#========================================================================
# STEP 4 - TRANSACTIONS AND STORED FUNCTIONS
#========================================================================

#
# STEP 4.1 - FUNCTION WITHIN A TRANSACTION
#
CREATE FUNCTION fn_add(x INT, y INT) RETURNS INT
BEGIN
INSERT INTO t1 VALUES (x, "INSERT x"),(y, "INSERT y");
RETURN x+y;
END |

## Clear history
CALL test.clear_history();

START TRANSACTION;
INSERT INTO t1 VALUES (410, "INSERT 410");
INSERT INTO t1 VALUES (411, "INSERT 411");
INSERT INTO t1 VALUES (412, "INSERT 412");
DELETE FROM t1 WHERE s1 > 410;

SELECT * FROM t1 ORDER BY s1;
s1	s2
410	INSERT 410

SELECT fn_add(413, 414);
fn_add(413, 414)
827
COMMIT;

SELECT * FROM t1 ORDER BY s1;
s1	s2
410	INSERT 410
413	INSERT x
414	INSERT y
#========================================================================
# Verify
#========================================================================
EVENTS_TRANSACTIONS_CURRENT

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

EVENTS_TRANSACTIONS_HISTORY_LONG

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

## Combined statement and transaction event history ordered by event id

EVENTS_STATEMENTS_HISTORY_LONG + EVENTS_TRANSACTIONS_HISTORY_LONG

EVENT_ID	EVENT_NAME               	NESTING_EVENT_ID	NESTING_EVENT_TYPE	SQL_TXT
event_id	statement/sql/begin      	nesting_event_id	NULL              	START TRANSACTION
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (410, "INSERT 410")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (411, "INSERT 411")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (412, "INSERT 412")
event_id	statement/sql/delete     	nesting_event_id	TRANSACTION       	DELETE FROM t1 WHERE s1 > 410
event_id	statement/sql/select     	nesting_event_id	TRANSACTION       	SELECT * FROM t1 ORDER BY s1
event_id	statement/sql/select     	nesting_event_id	TRANSACTION       	SELECT fn_add(413, 414)
event_id	statement/sp/stmt        	nesting_event_id	STATEMENT         	INSERT INTO t1 VALUES (x, "INSERT x"),(y, "INSERT y")
event_id	statement/sp/freturn     	nesting_event_id	STATEMENT         	NULL
event_id	statement/sql/commit     	nesting_event_id	TRANSACTION       	COMMIT
event_id	statement/sql/select     	nesting_event_id	NULL              	SELECT * FROM t1 ORDER BY s1
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>

## Clear statement and transaction history
CALL test.clear_history();
## Reset db.t1
DELETE FROM db.t1;


## Again, but this time with a rollback

START TRANSACTION;
SELECT fn_add(415, 416);
fn_add(415, 416)
831

ROLLBACK;

SELECT * FROM t1 ORDER BY s1;
s1	s2
#========================================================================
# Verify
#========================================================================
EVENTS_TRANSACTIONS_CURRENT

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

EVENTS_TRANSACTIONS_HISTORY_LONG

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	ROLLED BACK	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

## Combined statement and transaction event history ordered by event id

EVENTS_STATEMENTS_HISTORY_LONG + EVENTS_TRANSACTIONS_HISTORY_LONG

EVENT_ID	EVENT_NAME               	NESTING_EVENT_ID	NESTING_EVENT_TYPE	SQL_TXT
event_id	statement/sql/begin      	nesting_event_id	NULL              	START TRANSACTION
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/select     	nesting_event_id	TRANSACTION       	SELECT fn_add(415, 416)
event_id	statement/sp/stmt        	nesting_event_id	STATEMENT         	INSERT INTO t1 VALUES (x, "INSERT x"),(y, "INSERT y")
event_id	statement/sp/freturn     	nesting_event_id	STATEMENT         	NULL
event_id	statement/sql/rollback   	nesting_event_id	TRANSACTION       	ROLLBACK
event_id	statement/sql/select     	nesting_event_id	NULL              	SELECT * FROM t1 ORDER BY s1
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>

## Clear statement and transaction history
CALL test.clear_history();
## Reset db.t1
DELETE FROM db.t1;

#
# STEP 4.2 - TRANSACTION CANNOT BE STARTED OR ENDED WITHIN FUNCTION
#
CREATE FUNCTION fn_err1() RETURNS VARCHAR(10) BEGIN START TRANSACTION ; RETURN invalid ; END|
ERROR HY000: Explicit or implicit commit is not allowed in stored function or trigger.

## Expect 0 transactions
SELECT COUNT(*) FROM performance_schema.events_transactions_history;
COUNT(*)
0

## Expect syntax error

SELECT fn_err1();
ERROR 42000: FUNCTION db.fn_err1 does not exist

## Expect 0 transactions
SELECT COUNT(*) FROM performance_schema.events_transactions_history;
COUNT(*)
0

CREATE FUNCTION fn_err2() RETURNS VARCHAR(10) BEGIN COMMIT; RETURN invalid ; END|
ERROR HY000: Explicit or implicit commit is not allowed in stored function or trigger.

## Expect syntax error

START TRANSACTION;
DELETE FROM t1 WHERE s1 > 320;
SELECT fn_err2();
ERROR 42000: FUNCTION db.fn_err2 does not exist

## Expect 0 transactions
SELECT COUNT(*) FROM performance_schema.events_transactions_history;
COUNT(*)
0

## Clear transaction and statement tables
CALL test.clear_history();
#========================================================================
# STEP 5 - TRANSACTIONS AND TRIGGERS
#========================================================================

#
# STEP 5.1 - FORCE STATEMENT ROLLBACK FROM TRIGGER
#
## Create a trigger to force statement rollback

CREATE TRIGGER trigger_before_update BEFORE UPDATE ON t1
FOR EACH ROW
BEGIN
IF OLD.s1 >= 505 THEN
SIGNAL sqlstate '45001' SET message_text = "FORCE ERROR";
END IF;
END;|

## Clear history
CALL test.clear_history();

## Insert multiple rows, then update. Trigger will force rollback the
## UPDATE statement, but the transaction should not roll back.

START TRANSACTION;
INSERT INTO t1 VALUES (500, "INSERT 500");
INSERT INTO t1 VALUES (501, "INSERT 501");
INSERT INTO t1 VALUES (502, "INSERT 502");
INSERT INTO t1 VALUES (503, "INSERT 503");
INSERT INTO t1 VALUES (504, "INSERT 504");
INSERT INTO t1 VALUES (505, "INSERT 505");

SELECT * FROM t1 ORDER BY s1;
s1	s2
500	INSERT 500
501	INSERT 501
502	INSERT 502
503	INSERT 503
504	INSERT 504
505	INSERT 505

## Expect error when UPDATE hits record 505

UPDATE t1 SET s1 = s1 * 2 WHERE s1 >= 500;
ERROR 45001: FORCE ERROR

## Verify that INSERT succeeded, UPDATE failed and transaction did not rollback

SELECT * FROM t1 ORDER BY s1;
s1	s2
500	INSERT 500
501	INSERT 501
502	INSERT 502
503	INSERT 503
504	INSERT 504
505	INSERT 505
COMMIT;

DROP TRIGGER trigger_before_update;
#========================================================================
# Verify
#========================================================================
EVENTS_TRANSACTIONS_CURRENT

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

EVENTS_TRANSACTIONS_HISTORY_LONG

THREAD_ID	EVENT_ID	EVENT_NAME 	STATE      	ACCESS_MODE	ISOLATION_LEVEL 	AUTO	NESTING_EVENT_ID	NESTING_EVENT_TYPE
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	NO  	nesting_event_id	STATEMENT         
thread_id	event_id	transaction	COMMITTED  	READ WRITE 	REPEATABLE READ 	YES 	nesting_event_id	STATEMENT         

## Combined statement and transaction event history ordered by event id

EVENTS_STATEMENTS_HISTORY_LONG + EVENTS_TRANSACTIONS_HISTORY_LONG

EVENT_ID	EVENT_NAME               	NESTING_EVENT_ID	NESTING_EVENT_TYPE	SQL_TXT
event_id	statement/sql/begin      	nesting_event_id	NULL              	START TRANSACTION
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (500, "INSERT 500")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (501, "INSERT 501")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (502, "INSERT 502")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (503, "INSERT 503")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (504, "INSERT 504")
event_id	statement/sql/insert     	nesting_event_id	TRANSACTION       	INSERT INTO t1 VALUES (505, "INSERT 505")
event_id	statement/sql/select     	nesting_event_id	TRANSACTION       	SELECT * FROM t1 ORDER BY s1
event_id	statement/sql/update     	nesting_event_id	TRANSACTION       	UPDATE t1 SET s1 = s1 * 2 WHERE s1 >= 500
event_id	statement/sp/jump_if_not 	nesting_event_id	STATEMENT         	NULL
event_id	statement/sp/jump_if_not 	nesting_event_id	STATEMENT         	NULL
event_id	statement/sp/jump_if_not 	nesting_event_id	STATEMENT         	NULL
event_id	statement/sp/jump_if_not 	nesting_event_id	STATEMENT         	NULL
event_id	statement/sp/jump_if_not 	nesting_event_id	STATEMENT         	NULL
event_id	statement/sp/jump_if_not 	nesting_event_id	STATEMENT         	NULL
event_id	statement/sp/stmt        	nesting_event_id	STATEMENT         	SIGNAL sqlstate '45001' SET message_text = "FORCE ERROR"
event_id	statement/sql/select     	nesting_event_id	TRANSACTION       	SELECT * FROM t1 ORDER BY s1
event_id	statement/sql/commit     	nesting_event_id	TRANSACTION       	COMMIT
event_id	statement/sql/drop_trigge	nesting_event_id	NULL              	DROP TRIGGER trigger_before_update
event_id	transaction              	nesting_event_id	STATEMENT         	<transaction started>

## Clear statement and transaction history
CALL test.clear_history();
## Reset db.t1
DELETE FROM db.t1;

#=======================================================================
# Cleanup
#=======================================================================
DROP DATABASE db;
UPDATE performance_schema.setup_instruments SET enabled='YES', timed='YES';
DROP PROCEDURE clear_transaction_tables;
DROP PROCEDURE clear_transaction_history;
DROP PROCEDURE clear_statement_history;
DROP PROCEDURE clear_history;
DROP PROCEDURE transaction_verifier;
