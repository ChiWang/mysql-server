#
# Copyright (c) 2014, Oracle and/or its affiliates. All rights reserved.
#

# ==== Purpose ====
#
# WL#6559 Optimize GTIDs for passive slave - store GTIDs in table
#
# Verify that we can store gtids into gtid_executed table for XA transactions
# and report GLOBAL.GTID_EXECUTED and GLOBAL.GTID_PURGED correctly on
# master and slave when binlog is disabled on slave.
#

--source include/master-slave.inc
--source include/have_gtid.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc

SET @debug_save= @@GLOBAL.DEBUG;
--let $master_uuid= `SELECT @@GLOBAL.SERVER_UUID`
SHOW CREATE TABLE mysql.gtid_executed;

--echo # Verify that these gtids are stored into gtid table and can be
--echo # reported from global.gtid_executed for normal DDLs.
CREATE TABLE IF NOT EXISTS t1 (a int) engine=Innodb;
CREATE TABLE t2 (a int) engine=myisam;
--echo # Stored gtids MASTER_UUID:1-4 in gtid_executed table on master
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-2
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-2"
--source include/assert.inc

--echo # Verify that XA transactions' gtids are stored into gtid table and
--echo # can be reported from global.gtid_executed correctly.
INSERT INTO t2 values(1);
XA START '1';
INSERT INTO t2 values(2);
INSERT INTO t1 values(1);
INSERT INTO t1 values(2);
XA END '1';
XA PREPARE '1';
XA COMMIT '1';
--echo # Stored gtids MASTER_UUID:1-5 in gtid_executed table on master
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-5
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-5"
--source include/assert.inc
--echo # Verify that specified gtid is stored into gtid table for XA transaction
--echo # and can be reported from global.gtid_executed correctly.
--replace_result $master_uuid MASTER_UUID
--eval SET @@SESSION.GTID_NEXT= '$master_uuid:16'
SET @@GLOBAL.DEBUG= '+d,compress_gtid_table';
XA START '1';
INSERT INTO t1 values(3);
XA END '1';
XA PREPARE '1';
XA COMMIT '1';
--eval SET GTID_NEXT='AUTOMATIC'
SET DEBUG_SYNC='now WAIT_FOR complete_compression';
--echo # Stored gtids MASTER_UUID:1-5:16 in gtid_executed table on master
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-5:16
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-5:16"
--source include/assert.inc
SET GLOBAL DEBUG= @debug_save;

--sync_slave_with_master
--echo connection slave
--let $slave_uuid= `SELECT @@GLOBAL.SERVER_UUID`
call mtr.add_suppression("You need to use --log-bin to make --binlog-format work");

--echo # Verify that the transaction is skiped if its specified gtid
--echo # is already in gtid table.
--replace_result $master_uuid MASTER_UUID
--eval SET @@SESSION.GTID_NEXT= '$master_uuid:4'
INSERT INTO t1 values(11);
--let $assert_text= The transaction is skiped
--let $assert_cond= [SELECT count(*) FROM t1 WHERE a = 11] = 0
--source include/assert.inc
--echo # Stored gtids MASTER_UUID:1-5:16 in gtid_executed table on slave
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-5:16
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-5:16"
--source include/assert.inc

--echo # Verify that the specified gtid to GTID_NEXT is stored into
--echo # gtid table.
--replace_result $master_uuid MASTER_UUID
--eval SET @@SESSION.GTID_NEXT= '$master_uuid:17'
COMMIT;
--echo # Stored gtids MASTER_UUID:1-5:16-17 in gtid_executed table on slave
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-5:16-17
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-5:16-17"
--source include/assert.inc

--eval SET GTID_NEXT='AUTOMATIC'
--echo # Verify that no gtid is generated for transaction
--echo # when binlog is disabled
INSERT INTO t1 values(12);
--echo # Stored gtids MASTER_UUID:1-5:16-17 in gtid_executed table on slave.
--replace_result $master_uuid MASTER_UUID
--eval SELECT * FROM mysql.gtid_executed

--connection master
DROP TABLE t1, t2;
--sync_slave_with_master
--source include/rpl_end.inc
