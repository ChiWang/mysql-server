#
# Copyright (c) 2013, Oracle and/or its affiliates. All rights reserved.
#

# ==== Purpose ====
#
# WL#6559 Optimize GTIDs for passive slave - store GTIDs in table
#
# Verify that we can store gtids into gtid_executed table for transactions
# and report GLOBAL.GTID_EXECUTED and GLOBAL.GTID_PURGED correctly on
# master and slave when binlog is enabled.
#

--source include/master-slave.inc
--source include/have_gtid.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc
#--source include/have_binlog_format_statement.inc

--let $master_uuid= `SELECT @@GLOBAL.SERVER_UUID`
SHOW CREATE TABLE mysql.gtid_executed;

--echo # Verify that these gtids are stored into gtid table and can be
--echo # reported from global.gtid_executed for normal DDLs.
CREATE TABLE IF NOT EXISTS t1 (a int) engine=Innodb;
CREATE TABLE t2 (a int) engine=myisam;
--echo # Stored gtids MASTER_UUID:1-4 in gtid_executed table on master
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-2
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-2"
--source include/assert.inc

--echo # Verify that transactions' gtids are stored into gtid table and can be
--echo # reported from global.gtid_executed correctly.
INSERT INTO t2 values(1);
BEGIN;
INSERT INTO t2 values(2);
INSERT INTO t1 values(1);
INSERT INTO t1 values(2);
COMMIT;
--echo # Stored gtids MASTER_UUID:1-5 in gtid_executed table on master
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-5
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-5"
--source include/assert.inc

--sync_slave_with_master
--echo connection slave
--let $slave_uuid= `SELECT @@GLOBAL.SERVER_UUID`
call mtr.add_suppression("You need to use --log-bin to make --binlog-format work");

--echo # Verify that the transaction is skiped if its specified gtid
--echo # is already in gtid table.
--replace_result $master_uuid MASTER_UUID
--eval SET @@SESSION.GTID_NEXT= '$master_uuid:4'
INSERT INTO t1 values(11);
--echo # Stored gtids MASTER_UUID:1-5 in gtid_executed table on slave
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-5
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-5"
--source include/assert.inc

--echo # Verify that the specified gtid to GTID_NEXT is stored into
--echo # gtid table.
--replace_result $master_uuid MASTER_UUID
--eval SET @@SESSION.GTID_NEXT= '$master_uuid:17'
COMMIT;
--echo # Stored gtids MASTER_UUID:1-5:17 in gtid_executed table on slave
--replace_result $master_uuid MASTER_UUID
SELECT * FROM mysql.gtid_executed;
--let $assert_text= committed gtids MASTER_UUID:1-5:17
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$master_uuid:1-5:17"
--source include/assert.inc

--eval SET GTID_NEXT='AUTOMATIC'
--echo # Verify that no gtid is generated for transaction
--echo # when binlog is disabled
INSERT INTO t1 values(12);
--echo # Stored gtids MASTER_UUID:1-5:17 in gtid_executed table on slave.
--replace_result $master_uuid MASTER_UUID
--eval SELECT * FROM mysql.gtid_executed

--connection master
DROP TABLE t1, t2;
--sync_slave_with_master
--source include/rpl_end.inc
