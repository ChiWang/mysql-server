#
# Copyright (c) 2013, Oracle and/or its affiliates. All rights reserved.
#

# ==== Purpose ====
#
# This test script serves as the functionality testing for
# WL#6120- Change master without stopping Slave threads.
#
# This test script does the following:

#  - If both receiver and applier threads are stopped, relay logs should be
#    purged.
#  - If at least one of the receiver or applier is running, relay logs should
#    not be purged.
#
#  ==== Related Worklog(s) And Bug(s)====
#
#  WL#6120- Change master without stopping Slave threads.
#

--source include/master-slave.inc
--source include/have_binlog_format_mixed.inc

--connection slave

--echo
--echo List all the relay log files
--echo

-- let $datadir= `SELECT @@datadir`
-- let $index=$datadir/slave-relay-bin.index
-- chmod 0644 $index

# Since replace_regex doesnt work for cat_file, we display contents of index
# using the below hack. The same code snippet is used below instead of cat_file.

-- replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
-- eval SET @index=LOAD_FILE('$index')
-- replace_regex /\.[\\\/]slave/slave/
SELECT @index;

--echo
--echo We now stop the SQL thread and ensure that the relaylog files
--echo are not deleted on doing a change master with a running IO thread.
--echo

--source include/stop_slave_sql.inc
CHANGE MASTER to master_delay=20;

-- replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
-- eval SET @index=LOAD_FILE('$index')
-- replace_regex /\.[\\\/]slave/slave/
SELECT @index;

--echo
--echo We now stop the IO thread and ensure that the relaylog files
--echo are not deleted on doing a change master with a running SQL thread.
--echo

--source include/start_slave_sql.inc
--source include/stop_slave_io.inc
CHANGE MASTER to master_heartbeat_period=20;

-- replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
-- eval SET @index=LOAD_FILE('$index')
-- replace_regex /\.[\\\/]slave/slave/
SELECT @index;

--echo
--echo If the relay_log_file and relay_log_pos options are used, we dont purge
--echo relaylogs.
--echo

--source include/stop_slave.inc
# TODO: CHANGE MASTER to relay_log_pos= 20; ==> this hangs the test.
let $relay_log_file= query_get_value(SHOW SLAVE STATUS, Relay_Log_File, 1);
eval CHANGE MASTER TO relay_log_file='$relay_log_file';

let $relay_log_pos= query_get_value(SHOW SLAVE STATUS, Relay_Log_Pos, 1);
eval CHANGE MASTER TO relay_log_pos= $relay_log_pos;

-- replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
-- eval SET @index=LOAD_FILE('$index')
-- replace_regex /\.[\\\/]slave/slave/
SELECT @index;

--echo
--echo With both the threads stopped, relay logs should be deleted.
--echo

CHANGE MASTER to master_heartbeat_period=20;

-- replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
-- eval SET @index=LOAD_FILE('$index')
-- replace_regex /\.[\\\/]slave/slave/
SELECT @index;

--echo
--echo cleanup
--echo

CHANGE MASTER to master_delay=0;
CHANGE MASTER to master_heartbeat_period=60;

--source include/start_slave.inc
--source include/rpl_end.inc
