#
# This test file requires myisam and skips innodb entirely.
#

--source include/have_myisam.inc
--source include/not_master_info_table.inc
--source include/not_relay_log_info_table.inc
--source include/master-slave.inc

# Tests in this file will require debug builds
--source include/have_debug.inc

# Tests in this file are mostly binlog format agnostic, thus
# no need to rerun them for every format
--source include/have_binlog_format_row.inc

# BUG#18844897: ASSERT AT INFO.DRY_RUN

call mtr.add_suppression("Info table is not ready to be used. Table 'mysql.slave_.*_info' cannot be opened.");
call mtr.add_suppression("Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.");

# First create some binary log

CREATE TABLE t1(c1 INT) engine=MyISAM;
INSERT INTO t1 VALUES (1);
--source include/sync_slave_sql_with_master.inc
--source include/stop_slave.inc
--source include/rpl_connection_master.inc
--source include/stop_dump_threads.inc
--source include/rpl_connection_slave.inc

# this debug value forces myisam recovery as if LOG_EVENT_BINLOG_IN_USE_F
# was set in the log (as if the binary log had not been closed properly).
# The consequence is that the ha_recovery would be called for MYISAM,
# resulting on an assertion.
--let $rpl_server_parameters= --debug=+d,eval_force_bin_log_recovery --skip-slave-start
--let $rpl_server_number= 2
--source include/rpl_restart_server.inc

--source include/rpl_connection_slave.inc

# start the slave threads again
--disable_warnings
--source include/start_slave.inc
--enable_warnings

# Clean up
--source include/rpl_connection_master.inc
DROP TABLE t1;
--source include/sync_slave_sql_with_master.inc
--source include/rpl_connection_master.inc

--source include/rpl_end.inc
