include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.
[connection master]
call mtr.add_suppression("test the suppression statement");
SHOW CREATE TABLE mysql.gtid_executed;
Table	Create Table
gtid_executed	CREATE TABLE `gtid_executed` (
  `sid` char(36) NOT NULL COMMENT 'Textual representation of the sidno.',
  `gno_start` bigint(20) NOT NULL COMMENT 'First GNO of interval.',
  `gno_end` bigint(20) NOT NULL COMMENT 'Last GNO of interval.',
  PRIMARY KEY (`sid`,`gno_start`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
# Verify that the specified gtid to GTID_NEXT is stored into
# gtid table and can be reported from global.gtid_executed.
SET GTID_NEXT='MASTER_UUID:3';
BEGIN;
COMMIT;
# Stored gtids MASTER_UUID:1:3 in gtid_executed table on master
SELECT * FROM mysql.gtid_executed;
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	3	3
include/assert.inc [committed gtids MASTER_UUID:1:3]
SET GTID_NEXT='AUTOMATIC';
# Verify that these gtids are stored into gtid table and can be
# reported from global.gtid_executed for normal DDLs.
CREATE TABLE IF NOT EXISTS t1 (a INT) ENGINE=InnoDB;
CREATE TABLE t2 (a INT) ENGINE=MyISAM;
# Stored gtids MASTER_UUID:1-4 in gtid_executed table on master
SELECT * FROM mysql.gtid_executed;
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	2	2
MASTER_UUID	3	3
MASTER_UUID	4	4
include/assert.inc [committed gtids MASTER_UUID:1-4]
# Verify that these gtids are stored into gtid table and can be
# reported from global.gtid_executed for compound statement with
# regular and temporary tables.
CREATE TEMPORARY TABLE tmp1 (c1 INT) Engine=MyISAM;
CREATE TABLE t3 (a INT);
DROP TEMPORARY TABLE tmp1, t3;
ERROR 42S02: Unknown table 'test.t3'
DROP TABLE t3;
# Stored gtids MASTER_UUID:1-8 in gtid_executed table on master
SELECT * FROM mysql.gtid_executed;
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	2	2
MASTER_UUID	3	3
MASTER_UUID	4	4
MASTER_UUID	5	5
MASTER_UUID	6	6
MASTER_UUID	7	7
MASTER_UUID	8	8
include/assert.inc [committed gtids MASTER_UUID:1-8]
# Verify that transactions' gtids are stored into gtid table and can be
# reported from global.gtid_executed correctly.
BEGIN;
INSERT INTO t2 VALUES(2);
INSERT INTO t1 VALUES(1);
INSERT INTO t1 VALUES(2);
COMMIT;
# Verify that specified gtid is stored into gtid table for transaction
# and can be reported from global.gtid_executed correctly.
SET @@SESSION.GTID_NEXT= 'MASTER_UUID:11';
BEGIN;
INSERT INTO t1 VALUES(3);
COMMIT;
SET GTID_NEXT='AUTOMATIC';
# Stored gtids MASTER_UUID:1-11 in gtid_executed table on master
SELECT * FROM mysql.gtid_executed;
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	2	2
MASTER_UUID	3	3
MASTER_UUID	4	4
MASTER_UUID	5	5
MASTER_UUID	6	6
MASTER_UUID	7	7
MASTER_UUID	8	8
MASTER_UUID	9	9
MASTER_UUID	10	10
MASTER_UUID	11	11
include/assert.inc [committed gtids MASTER_UUID:1-11]
# Verify that transaction's gtid is not stored into gtid table
# if the transaction is rollbacked.
BEGIN;
INSERT INTO t1 VALUES(4);
ROLLBACK;
# Stored gtids MASTER_UUID:1-11 in gtid_executed table on master
SELECT * FROM mysql.gtid_executed;
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	2	2
MASTER_UUID	3	3
MASTER_UUID	4	4
MASTER_UUID	5	5
MASTER_UUID	6	6
MASTER_UUID	7	7
MASTER_UUID	8	8
MASTER_UUID	9	9
MASTER_UUID	10	10
MASTER_UUID	11	11
include/assert.inc [committed gtids MASTER_UUID:1-11]
# Verify that transaction's gtid is not stored into gtid table
# and the transaction is rolled back if we encounter an error
# when writing gtid into table.
SET SESSION debug="+d,simulate_err_on_write_gtid_into_table";
INSERT INTO t1 VALUES(5);
ERROR HY000: Got error -1 from storage engine
SET SESSION debug="-d,simulate_err_on_write_gtid_into_table";
# Stored gtids MASTER_UUID:1-11 in gtid_executed table on master
SELECT * FROM mysql.gtid_executed;
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	2	2
MASTER_UUID	3	3
MASTER_UUID	4	4
MASTER_UUID	5	5
MASTER_UUID	6	6
MASTER_UUID	7	7
MASTER_UUID	8	8
MASTER_UUID	9	9
MASTER_UUID	10	10
MASTER_UUID	11	11
include/assert.inc [committed gtids MASTER_UUID:1-11]
include/assert.inc [Table t1 must not contain 5]
include/sync_slave_sql_with_master.inc
connection slave
# Verify that the transaction is skiped if its specified gtid
# is already in gtid table.
SET @@SESSION.GTID_NEXT= 'MASTER_UUID:6';
INSERT INTO t1 VALUES(11);
include/assert.inc [Table t1 must not contain 11]
# Stored gtids MASTER_UUID:1-11 in gtid_executed table on slave
SELECT * FROM mysql.gtid_executed;
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	2	2
MASTER_UUID	3	3
MASTER_UUID	4	4
MASTER_UUID	5	5
MASTER_UUID	6	6
MASTER_UUID	7	7
MASTER_UUID	8	8
MASTER_UUID	9	9
MASTER_UUID	10	10
MASTER_UUID	11	11
# Verify that the specified gtid to GTID_NEXT is stored into
# gtid table.
SET @@SESSION.GTID_NEXT= 'MASTER_UUID:17';
COMMIT;
# Stored gtids MASTER_UUID:1-11:17 in gtid_executed table on slave
SELECT * FROM mysql.gtid_executed;
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	2	2
MASTER_UUID	3	3
MASTER_UUID	4	4
MASTER_UUID	5	5
MASTER_UUID	6	6
MASTER_UUID	7	7
MASTER_UUID	8	8
MASTER_UUID	9	9
MASTER_UUID	10	10
MASTER_UUID	11	11
MASTER_UUID	17	17
include/assert.inc [committed gtids MASTER_UUID:1-11:17]
SET GTID_NEXT='AUTOMATIC';
FLUSH LOGS;
# Verify that we can get the correct set of gtid_purged
# when purging logs.
PURGE BINARY LOGS TO 'slave-bin.000002';
include/assert.inc [purged gtids MASTER_UUID:1-11:17]
# Verify that transaction's gtid generated on slave is stored
# into gtid table.
BEGIN;
INSERT INTO t1 VALUES(12);
COMMIT;
# Stored gtids MASTER_UUID:1-11:17 and SLAVE_UUID:1
# in gtid_executed table on slave.
SELECT * FROM mysql.gtid_executed where sid="MASTER_UUID";
sid	gno_start	gno_end
MASTER_UUID	1	1
MASTER_UUID	2	2
MASTER_UUID	3	3
MASTER_UUID	4	4
MASTER_UUID	5	5
MASTER_UUID	6	6
MASTER_UUID	7	7
MASTER_UUID	8	8
MASTER_UUID	9	9
MASTER_UUID	10	10
MASTER_UUID	11	11
MASTER_UUID	17	17
SELECT * FROM mysql.gtid_executed where sid="SLAVE_UUID";
sid	gno_start	gno_end
SLAVE_UUID	1	1
DROP TABLE t1, t2;
include/rpl_end.inc
