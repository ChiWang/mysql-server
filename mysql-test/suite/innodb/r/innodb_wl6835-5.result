CREATE TABLE t1 (c1 INT NOT NULL PRIMARY KEY, c2 INT NOT NULL, c3 INT NOT NULL) ENGINE=InnoDB;
INSERT INTO t1 VALUES (0, 0, 0);

# On connection 1
START TRANSACTION READ ONLY;
SELECT c1, c2 FROM t1 WHERE c1=0 LOCK IN SHARE MODE;
c1	c2
0	0

# On connection 2
START TRANSACTION;
UPDATE t1 SET c1=2 WHERE c1=0 AND c2=0;

# On connection 3
START TRANSACTION HIGH_PRIORITY;
UPDATE t1 SET c1=3 WHERE c1=0;

# On connection 1
sleep
COMMIT;
ERROR HY000: Got error 149 during COMMIT

# On connection 3
COMMIT;

# On connection 2
COMMIT;
SELECT * FROM t1;
c1	3
c2	0
c3	0
DROP TABLE t1;
