#
# WL#7682: Optimize InnoDB temporary tables.
#

--source include/have_innodb.inc

################################################################################
#
# 1. Create/Drop sequence.
# 2. Basic DML operation on intrinsic table.
# 3. Run different types of queries on intrinsic table.
# 4. Multiple key DML
#
################################################################################

#-----------------------------------------------------------------------------
#
# create test bed.
#
let $innodb_int = `select@@innodb_create_intrinsic`;
set session innodb_create_intrinsic = 1;

#-----------------------------------------------------------------------------
#
# 1. Create/Drop sequence.
#
create temporary table t1 (i int, j int, primary key pk(i)) engine = innodb;
create temporary table t2 (i int, j int, primary key pk(i)) engine = innodb;
create temporary table t3 (i int, j int, primary key pk(i)) engine = innodb;
create temporary table t4 (i int, j int, primary key pk(i)) engine = innodb;
drop table t1,t2,t3,t4;
#
create temporary table t1 (i int, j int, primary key pk(i)) engine = innodb;
drop table t1;

#-----------------------------------------------------------------------------
#
# 2. Basic DML operation on intrinsic table.
#
use test;
create temporary table t1
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc)) engine = innodb;
delimiter |;
CREATE PROCEDURE populate_t1()
BEGIN
	DECLARE i INT DEFAULT 1;
	while (i <= 2000) DO
		insert into t1 values (i, 'a', 'b');
		SET i = i + 1;
	END WHILE;
END|
delimiter ;|
#
begin; call populate_t1(); commit; select count(*) from t1;
--error ER_ILLEGAL_HA
truncate t1;
delete from t1 where keyc < 1000; select count(*) from t1;
update t1 set c1 = 'aefafdf' where keyc < 1500; select count(*) from t1;
update t1 set c2 = '141434' where keyc < 2000; select count(*) from t1;
delete from t1; select count(*) from t1;
#
alter table t1 add index sk(c1);
#
begin; call populate_t1(); commit; select count(*) from t1;
--error ER_ILLEGAL_HA
truncate t1;
delete from t1 where keyc < 1000; select count(*) from t1;
update t1 set c1 = 'aefafdf' where keyc < 1500; select count(*) from t1;
update t1 set c2 = '141434' where keyc < 2000; select count(*) from t1;
delete from t1; select count(*) from t1;
#
#
drop procedure populate_t1;
drop table t1;

#-----------------------------------------------------------------------------
#
# 3. Run different types of queries on intrinsic table.
#
--source suite/innodb/include/create_workload_itt.inc
--source suite/innodb/include/query_workload_itt.inc
--source suite/innodb/include/drop_workload_itt.inc

#-----------------------------------------------------------------------------
#
# 4. Multiple key DML
#
create temporary table t1 (
	a int, b int, c int,
	primary key pk(a), index sk(b), index sk2(c)) engine=innodb;
insert into t1 values (1,1,1), (2,2,2), (3,3,3);
update t1 set c = 4 where c = 2;
update t1 set b = 6 where b = 2;
update t1 set a = 100 where a = 1;
--error ER_DUP_ENTRY
update t1 set a = 3 where a = 2;
drop table t1;

#-----------------------------------------------------------------------------
#
# remove test bed.
#
eval set session innodb_create_intrinsic = $innodb_int;

