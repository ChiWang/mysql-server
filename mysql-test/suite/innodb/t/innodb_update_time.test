#
# Test that INFORMATION_SCHEMA.TABLES.UPDATE_TIME is filled
# correctly for InnoDB tables.
#

-- source include/have_innodb.inc

CREATE TABLE t (a INT) ENGINE=INNODB;

SELECT update_time FROM information_schema.tables WHERE table_name = 't';

INSERT INTO t VALUES (1);

SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 't'
AND update_time IS NOT NULL;

# We cant deterministically check that the saved value is correct, but
# at least we check that it is a timestamp not older than 2 minutes.
# Usually update_time and NOW() are equal below, but on heavily loaded
# machines NOW() could be younger.
SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 't'
AND TIMESTAMPDIFF(SECOND, update_time, NOW()) < 120;

CREATE TABLE big (a TEXT) ENGINE=INNODB;

SELECT COUNT(*) FROM information_schema.innodb_buffer_page
WHERE table_name = '`test`.`t`';

-- disable_query_log
-- let $i = 8192
while ($i)
{
	INSERT INTO big VALUES (REPEAT('a', 1024));
	dec $i;
}
-- enable_query_log

# confirm that table 't' has been evicted
SELECT COUNT(*) FROM information_schema.innodb_buffer_page
WHERE table_name = '`test`.`t`';

SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 't'
AND update_time IS NOT NULL;

DROP TABLE big;
DROP TABLE t;
