# =====================  purpose  =================================
#
# Test case1, verify that 'TRUNCATE TABLE' statement works fine and
# the size of .ibd file is equal to the initial size after truncation.
#
# Test case2, verify that the internal InnoDB 'TRUNCATE TABLE' statement
# is atomic, recovery works fine from a crash during the truncation.
#

# Valgrind would complain about memory leaks when we crash on purpose.
--source include/not_valgrind.inc
# Embedded server does not support crashing
--source include/not_embedded.inc
# Avoid CrashReporter popup on Mac
--source include/not_crashrep.inc

--source include/have_innodb_16k.inc
--source include/have_debug.inc

--disable_query_log
let $MYSQL_DATA_DIR= `select @@datadir`;
let $data_directory = data directory='$MYSQL_TMP_DIR/alt_dir';

let $innodb_file_per_table_orig=`select @@innodb_file_per_table`;
let $innodb_file_format_orig=`select @@innodb_file_format`;
let $innodb_file_format_max_orig=`select @@innodb_file_format_max`;
--enable_query_log

set global innodb_file_per_table=on;

--echo # Verify that 'TRUNCATE TABLE' statement works fine and the size
--echo # of .ibd file is equal to the initial size after truncation.
--source suite/innodb/t/innodb_wl6501_truncate_size.inc

--disable_query_log
set session debug="+d,crash_during_drop_second_secondary";
--enable_query_log
--echo # Verify that recovery works fine from a crash during
--echo # the drop of the second secondary to a table with
--echo # remote data directory and dynamic format.
--source suite/innodb/t/innodb_wl6501_remote_dir.inc
--disable_query_log
set session debug="-d,crash_during_drop_second_secondary";
--enable_query_log

--disable_query_log
set session debug="+d,crash_during_create_second_secondary";
--enable_query_log
--echo # Verify that recovery works fine from a crash during the creation
--echo # of the second secondary to a table with redundant format.
--source suite/innodb/t/innodb_wl6501_redundant.inc
--disable_query_log
set session debug="-d,crash_during_create_second_secondary";
--enable_query_log

--disable_query_log
set session debug="+d,crash_before_log_checkpoint";
--enable_query_log
--echo # Verify that recovery works fine from a crash before
--echo # log checkpoint to a table with compact format.
--source suite/innodb/t/innodb_wl6501_compact.inc
--disable_query_log
set session debug="-d,crash_before_log_checkpoint";
--enable_query_log

--disable_query_log
set session debug="+d,crash_after_log_checkpoint";
--enable_query_log
--echo # Verify that recovery works fine from a crash after
--echo # log checkpoint to a table with 8k block size.
--source suite/innodb/t/innodb_wl6501_zip_8k.inc
--disable_query_log
set session debug="-d,crash_after_log_checkpoint";
--enable_query_log

--disable_query_log
set session debug="+d,crash_after_truncate_tablespace";
--enable_query_log
--echo # Verify that recovery works fine from a crash after physically
--echo # truncated the tablespace to a table with 4k block size.
--source suite/innodb/t/innodb_wl6501_zip_4k.inc
--disable_query_log
set session debug="-d,crash_after_truncate_tablespace";
--enable_query_log

--disable_query_log
set session debug="+d,crash_after_truncate_tablespace";
--enable_query_log
--echo # Verify that recovery works fine from a crash after physically
--echo # truncated the tablespace to a table with 2k block size.
--source suite/innodb/t/innodb_wl6501_zip_2k.inc
--disable_query_log
set session debug="-d,crash_after_truncate_tablespace";
--enable_query_log

--disable_query_log
set session debug="+d,crash_after_drop_tablespace";
--enable_query_log
--echo # Verify that the TRUNCATE TABLE statement works fine
--echo # if the tablespace is missing.
--source suite/innodb/t/innodb_wl6501_tablespace_missing.inc
--disable_query_log
set session debug="-d,crash_after_drop_tablespace";
--enable_query_log

--disable_query_log
set session debug="+d,crash_if_ibd_file_is_missing";
--enable_query_log
--echo # Verify that the TRUNCATE TABLE statement is rollbacked
--echo # and the table is marked as corrupt when the .ibd file
--echo # is missing.
--source suite/innodb/t/innodb_wl6501_ibd_missing.inc
--disable_query_log
set session debug="-d,crash_if_ibd_file_is_missing";
--enable_query_log

-- disable_query_log
eval set global innodb_file_format=$innodb_file_format_orig;
eval set global innodb_file_format_max=$innodb_file_format_max_orig;
eval set global innodb_file_per_table=$innodb_file_per_table_orig;
-- enable_query_log

