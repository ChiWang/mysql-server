#
# WL#6501: make truncate table atomic
#

--source include/have_innodb.inc

################################################################################
#
# Will test following scenarios:
# 1. Test some basic dml action involving truncate of table.
# 2. Test that truncating reference table is blocked.
# 3. Test truncate of loaded table that has blob + compression. 
#
################################################################################

#-----------------------------------------------------------------------------
#
# create test-bed
#
let $per_table = `select @@innodb_file_per_table`;
let $format = `select @@innodb_file_format`;

set global innodb_file_per_table = on;
let $MYSQL_TMP_DIR = `select @@tmpdir`;
let $MYSQL_DATA_DIR = `select @@datadir`;
let SEARCH_FILE = $MYSQLTEST_VARDIR/log/my_restart.err;

#-----------------------------------------------------------------------------
#
# 1. Test some basic dml action involving truncate of table.
#
--echo "1. Test some basic dml action involving truncate of table."
use test;
set global innodb_file_per_table = 0;
create table t1
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc), index sec_index(c1)
        ) engine = innodb;
create table t2
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc), index sec_index(c1)
        ) engine = innodb;
--source suite/innodb/include/innodb_dml_ops.inc
drop table t1;
drop table t2;
#
create temporary table t1
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc), index sec_index(c1)
        ) engine = innodb;
create temporary table t2
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc), index sec_index(c1)
        ) engine = innodb;
--source suite/innodb/include/innodb_dml_ops.inc
drop table t1;
drop table t2;
#
set global innodb_file_per_table = 1;
create table t1
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc), index sec_index(c1)
        ) engine = innodb;
create table t2
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc), index sec_index(c1)
        ) engine = innodb;
--source suite/innodb/include/innodb_dml_ops.inc
drop table t1;
drop table t2;
#
create temporary table t1
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc), index sec_index(c1)
        ) engine = innodb;
create temporary table t2
        (keyc int, c1 char(100), c2 char(100),
         primary key(keyc), index sec_index(c1)
        ) engine = innodb;
--source suite/innodb/include/innodb_dml_ops.inc
drop table t1;
drop table t2;

#-----------------------------------------------------------------------------
#
# 2. Test that truncating reference table is blocked.
#
--echo "2. Test that truncating reference table is blocked."
use test;
#
create table master
	(i int, f float, c char(100),
	 primary key pk(i), index fidx(f))
	engine = innodb;
#
create table slave
	(i int, j int,
	 primary key pk(i),
	 foreign key fk(j) references master(i))
	engine = innodb;
#
insert into master values
	(1, 1.1, 'a'), (2, 2.2, 'b'), (3, 3.3, 'c'),
	(4, 4.4, 'd'), (5, 5.5, 'e');
#
insert into slave values
	(101, 1), (202, 3), (303, 5);
#
select * from master;
select * from slave;
#
--error ER_TRUNCATE_ILLEGAL_FK
truncate table master;
#
drop table slave;
drop table master;

#-----------------------------------------------------------------------------
#
# 3. Test truncate of loaded table that has blob + compression. 
#
--echo "3. Test truncate of loaded table that has blob + compression."
use test;
#
delimiter |;
create procedure populate_t1()
begin
        declare i int default 1;
        while (i <= 200) DO
                insert into t1 values (i, i, repeat(concat('tc3_', i), 1000),
				       repeat('a', 1000));
                set i = i + 1;
        end while;
end|
delimiter ;|
#
set global innodb_file_per_table = 0;
create table t1 (a int not null, d int not null, b blob not null, c text,
	primary key (b(10), a, d),  index (d), index(a),  index (c(355),
	b(255)), index (b(5), c(10), a)
	) engine=InnoDB;
call populate_t1();
select count(*) from t1;
#
set session debug = "+d,ib_trunc_crash_before_log_checkpoint";
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
truncate table t1;
#
--enable_reconnect
--echo # Restart the MySQL server
--source include/wait_until_connected_again.inc
--disable_reconnect
check table t1;
select count(*) from t1;
call populate_t1();
select count(*) from t1;
drop table t1;
#
set global innodb_file_per_table = 1;
set global innodb_file_format='Barracuda';
--disable_warnings
create table t1 (a int not null, d int not null, b blob not null, c text,
	primary key (b(10), a, d),  index (d), index(a),  index (c(355),
	b(255)), index (b(5), c(10), a)
	) engine=InnoDB row_format=compressed key_block_size=8;
--enable_warnings
call populate_t1();
select count(*) from t1;
#
set session debug = "+d,ib_trunc_crash_before_log_checkpoint";
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
truncate table t1;
#
--enable_reconnect
--echo # Restart the MySQL server
--source include/wait_until_connected_again.inc
--disable_reconnect
check table t1;
select count(*) from t1;
call populate_t1();
select count(*) from t1;
drop table t1;
#
drop procedure populate_t1;

#-----------------------------------------------------------------------------
#
# remove test-bed
#
eval set global innodb_file_format = $format;
eval set global innodb_file_per_table = $per_table;

