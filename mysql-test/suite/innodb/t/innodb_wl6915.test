#
# WL#6560: InnoDB: separate tablespace for innodb-temp-tables.
#

--source include/have_innodb.inc
--source include/have_debug.inc

# Valgrind would complain about memory leaks when we crash on purpose.
--source include/not_valgrind.inc
# Embedded server does not support crashing
--source include/not_embedded.inc
# Avoid CrashReporter popup on Mac
--source include/not_crashrep.inc

################################################################################
#
# Will test following scenarios:
# 1. Try loading table with commit and rollback action.
# 2. In same trx try loading temp + non-temp table.
#
################################################################################

#-----------------------------------------------------------------------------
#
# create test-bed
#
let $per_table = `select @@innodb_file_per_table`;
let $format = `select @@innodb_file_format`;

set global innodb_file_per_table = off;
let $MYSQL_TMP_DIR = `select @@tmpdir`;
let $MYSQL_DATA_DIR = `select @@datadir`;
let SEARCH_FILE = $MYSQLTEST_VARDIR/log/my_restart.err;
let $args = --loose-console > $SEARCH_FILE 2>&1;
let crash = $args --innodb-force-recovery-crash;

#-----------------------------------------------------------------------------
#
# 1. Try loading table with commit and rollback action.
#
use test;
create temporary table t1
	(a int, b char(100), c char(100)) engine = innodb;
--source suite/innodb/include/innodb_undo_logs_action.inc
drop table t1;
#
create table t1
	(a int, b char(100), c char(100)) engine = innodb;
--source suite/innodb/include/innodb_undo_logs_action.inc
drop table t1;

#-----------------------------------------------------------------------------
#
# 2. In same trx try loading temp + non-temp table.
#
use test;
create temporary table t1
	(a int, b char(100), c char(100)) engine = innodb;
create table t2
	(a int, b char(100), c char(100)) engine = innodb;
delimiter |;
create procedure populate_t1_t2()
begin
	declare i int default 1;
	while (i <= 2000) DO
		insert into t1 values (i, 'a', 'b');
		insert into t2 values (i, 'a', 'b');
		set i = i + 1;
	end while;
end|
delimiter ;|
begin;
call populate_t1_t2();
commit;
select count(*) from t1;
select count(*) from t2;
select * from t2 limit 10;
set session debug="+d,ib_crash_during_commit_with_standard_undo_committed";
--exec echo "restart " > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
begin;
call populate_t1_t2();
--error 2013
commit;
#
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect
#
select count(*) from t2;
select * from t2 limit 10;
drop procedure populate_t1_t2;
drop table t2;


#-----------------------------------------------------------------------------
#
# remove test-bed
#
eval set global innodb_file_format = $format;
eval set global innodb_file_per_table = $per_table;


