#
# wl#7277: InnoDB: Bulk Load for Create Index
#

# Not supported in embedded
-- source include/not_embedded.inc

# This test case needs to crash the server. Needs a debug server.
-- source include/have_debug.inc

# Don't test this under valgrind, memory leaks will occur.
-- source include/not_valgrind.inc

# Avoid CrashReporter popup on Mac
-- source include/not_crashrep.inc

-- source include/have_innodb.inc

# Test scenarios:
# for three cases: default row format, compressed table, blob.
# 1. Test restart;
# 2. Test crash recovery.

-- echo # Test Case 1: Test Restart
-- echo # Test Default Row Format
CREATE TABLE t1(
	class	INT,
	id	INT,
	title	VARCHAR(100)
) ENGINE=InnoDB;

-- disable_warnings
LOAD DATA INFILE '../../std_data/wl7277_10000.dat' INTO TABLE t1 FIELDS TERMINATED BY ':';
-- enable_warnings

SELECT COUNT(*) FROM t1;

CREATE INDEX idx_id ON t1(id);

CREATE INDEX idx_title ON t1(title);

--echo # Shutdown and restart mysqld
--source include/shutdown_mysqld.inc
--source include/start_mysqld.inc

CHECK TABLE t1;

EXPLAIN SELECT * FROM t1 WHERE id = 10;
EXPLAIN SELECT * FROM t1 WHERE title = 'AccessibleComputing';

SELECT * FROM t1 WHERE id = 10;
SELECT * FROM t1 WHERE title = 'AccessibleComputing';

SELECT * FROM t1 WHERE id = 8051;
SELECT * FROM t1 WHERE title = 'History of Dominica';

SELECT * FROM t1 WHERE id = 15517;
SELECT * FROM t1 WHERE title = 'ITSO';

SELECT * FROM t1 WHERE id = 74607;
SELECT * FROM t1 WHERE title = 'Big cats';

DROP TABLE t1;

-- echo # Test Compressed Table
SET GLOBAL innodb_file_per_table=1;
SET GLOBAL innodb_file_format=Barracuda;

CREATE TABLE t1(
	class	INT,
	id	INT,
	title	VARCHAR(100)
) ENGINE=InnoDB ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=4;

-- disable_warnings
LOAD DATA INFILE '../../std_data/wl7277_10000.dat' INTO TABLE t1 FIELDS TERMINATED BY ':';
-- enable_warnings

SELECT COUNT(*) FROM t1;

CREATE INDEX idx_id ON t1(id);

CREATE INDEX idx_title ON t1(title);

--echo # Shutdown and restart mysqld
--source include/shutdown_mysqld.inc
--source include/start_mysqld.inc

CHECK TABLE t1;

EXPLAIN SELECT * FROM t1 WHERE id = 10;
EXPLAIN SELECT * FROM t1 WHERE title = 'AccessibleComputing';

SELECT * FROM t1 WHERE id = 10;
SELECT * FROM t1 WHERE title = 'AccessibleComputing';

SELECT * FROM t1 WHERE id = 8051;
SELECT * FROM t1 WHERE title = 'History of Dominica';

SELECT * FROM t1 WHERE id = 15517;
SELECT * FROM t1 WHERE title = 'ITSO';

SELECT * FROM t1 WHERE id = 74607;
SELECT * FROM t1 WHERE title = 'Big cats';

DROP TABLE t1;

SET GLOBAL innodb_file_per_table=DEFAULT;
SET GLOBAL innodb_file_format=DEFAULT;

-- echo # Test Blob
CREATE TABLE t1(
	a INT PRIMARY KEY,
	b TEXT,
	c TEXT) ENGINE=InnoDB;

INSERT INTO t1 VALUES
	(1, REPEAT('a',10000), 'a'),
	(2, REPEAT('b',20000), 'b'),
	(3, REPEAT('c',40000), 'c'),
	(4, REPEAT('d',60000), 'd');

SELECT CHAR_LENGTH(b) FROM t1;

ALTER TABLE t1 DROP COLUMN c;

--echo # Shutdown and restart mysqld
--source include/shutdown_mysqld.inc
--source include/start_mysqld.inc

CHECK TABLE t1;

SELECT CHAR_LENGTH(b) FROM t1;

DROP TABLE t1;

SET GLOBAL innodb_file_per_table=1;
SET GLOBAL innodb_file_format=Barracuda;

CREATE TABLE t1(
	a INT PRIMARY KEY,
	b TEXT,
	c TEXT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=4;

INSERT INTO t1 VALUES
	(1, REPEAT('a',10000), 'a'),
	(2, REPEAT('b',20000), 'b'),
	(3, REPEAT('c',40000), 'c'),
	(4, REPEAT('d',60000), 'd');

SELECT CHAR_LENGTH(b) FROM t1;

ALTER TABLE t1 DROP COLUMN c;

--echo # Shutdown and restart mysqld
--source include/shutdown_mysqld.inc
--source include/start_mysqld.inc

CHECK TABLE t1;

SELECT CHAR_LENGTH(b) FROM t1;

DROP TABLE t1;

SET GLOBAL innodb_file_per_table=DEFAULT;
SET GLOBAL innodb_file_format=DEFAULT;

-- echo # Test Case 2: Test Crash Recovery
-- echo # Test Default Row Format
CREATE TABLE t1(
        class   INT,
        id      INT,
        title   VARCHAR(100)
) ENGINE=InnoDB;

-- disable_warnings
LOAD DATA INFILE '../../std_data/wl7277_10000.dat' INTO TABLE t1 FIELDS TERMINATED BY ':';
-- enable_warnings

SET SESSION debug="+d,crash_commit_before";

# Write file to make mysql-test-run.pl start up the server again
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
CREATE INDEX idx_title ON t1(title);

--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SELECT COUNT(*) FROM t1;

CHECK TABLE t1;

EXPLAIN SELECT * FROM t1 WHERE title = 'AccessibleComputing';

SELECT * FROM t1 WHERE title = 'AccessibleComputing';

SELECT * FROM t1 WHERE title = 'History of Dominica';

SELECT * FROM t1 WHERE title = 'ITSO';

SELECT * FROM t1 WHERE title = 'Big cats';

DROP TABLE t1;

-- echo # Test Compress Table
SET GLOBAL innodb_file_per_table=1;
SET GLOBAL innodb_file_format=Barracuda;

CREATE TABLE t1(
        class   INT,
        id      INT,
        title   VARCHAR(100)
) ENGINE=InnoDB ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=4;

-- disable_warnings
LOAD DATA INFILE '../../std_data/wl7277_10000.dat' INTO TABLE t1 FIELDS TERMINATED BY ':';
-- enable_warnings

SET SESSION debug="+d,crash_commit_before";

# Write file to make mysql-test-run.pl start up the server again
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
CREATE INDEX idx_title ON t1(title);

--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

SELECT COUNT(*) FROM t1;

CHECK TABLE t1;

EXPLAIN SELECT * FROM t1 WHERE title = 'AccessibleComputing';

SELECT * FROM t1 WHERE title = 'AccessibleComputing';

SELECT * FROM t1 WHERE title = 'History of Dominica';

SELECT * FROM t1 WHERE title = 'ITSO';

SELECT * FROM t1 WHERE title = 'Big cats';

DROP TABLE t1;

SET GLOBAL innodb_file_per_table=DEFAULT;
SET GLOBAL innodb_file_format=DEFAULT;

-- echo # Test Blob
CREATE TABLE t1(
	a INT PRIMARY KEY,
	b TEXT,
	c TEXT) ENGINE=InnoDB;

INSERT INTO t1 VALUES
	(1, REPEAT('a',10000), 'a'),
	(2, REPEAT('b',20000), 'b'),
	(3, REPEAT('c',40000), 'c'),
	(4, REPEAT('d',60000), 'd');

SELECT CHAR_LENGTH(b) FROM t1;

SET SESSION debug="+d,crash_commit_before";

# Write file to make mysql-test-run.pl start up the server again
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
ALTER TABLE t1 DROP COLUMN c;

--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

CHECK TABLE t1;

SELECT CHAR_LENGTH(b) FROM t1;

DROP TABLE t1;

SET GLOBAL innodb_file_per_table=1;
SET GLOBAL innodb_file_format=Barracuda;

CREATE TABLE t1(
	a INT PRIMARY KEY,
	b TEXT,
	c TEXT) ENGINE=InnoDB ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=4;

INSERT INTO t1 VALUES
	(1, REPEAT('a',10000), 'a'),
	(2, REPEAT('b',20000), 'b'),
	(3, REPEAT('c',40000), 'c'),
	(4, REPEAT('d',60000), 'd');

SELECT CHAR_LENGTH(b) FROM t1;

SET SESSION debug="+d,crash_commit_before";

# Write file to make mysql-test-run.pl start up the server again
--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect

--error 2013
ALTER TABLE t1 DROP COLUMN c;

--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

CHECK TABLE t1;

SELECT CHAR_LENGTH(b) FROM t1;

DROP TABLE t1;

SET GLOBAL innodb_file_per_table=DEFAULT;
SET GLOBAL innodb_file_format=DEFAULT;
